(function(){var t={}.hasOwnProperty,n=function(n,e){function o(){this.constructor=n}for(var r in e)t.call(e,r)&&(n[r]=e[r]);return o.prototype=e.prototype,n.prototype=new o,n.__super__=e.prototype,n};WebSocketRails.HttpConnection=function(t){function e(t,n){var o;this.dispatcher=n,e.__super__.constructor.apply(this,arguments),this._url="http://"+t,this._conn=this._createXMLHttpObject(),this.last_pos=0;try{this._conn.onreadystatechange=function(t){return function(){return t._parse_stream()}}(this),this._conn.addEventListener("load",this.on_close,!1)}catch(r){o=r,this._conn.onprogress=function(t){return function(){return t._parse_stream()}}(this),this._conn.onload=this.on_close,this._conn.readyState=3}this._conn.open("GET",this._url,!0),this._conn.send()}return n(e,t),e.prototype.connection_type="http",e.prototype._httpFactories=function(){return[function(){return new XDomainRequest},function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Msxml3.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")}]},e.prototype.close=function(){return this._conn.abort()},e.prototype.send_event=function(t){return e.__super__.send_event.apply(this,arguments),this._post_data(t.serialize())},e.prototype._post_data=function(t){return $.ajax(this._url,{type:"POST",data:{client_id:this.connection_id,data:t},success:function(){}})},e.prototype._createXMLHttpObject=function(){var t,n,e,o,r,s;for(o=!1,n=this._httpFactories(),r=0,s=n.length;s>r;r++){e=n[r];try{o=e()}catch(c){t=c;continue}break}return o},e.prototype._parse_stream=function(){var t,n,e;if(3===this._conn.readyState){t=this._conn.responseText.substring(this.last_pos),this.last_pos=this._conn.responseText.length,t=t.replace(/\]\]\[\[/g,"],[");try{return e=JSON.parse(t),this.on_message(e)}catch(o){n=o}}},e}(WebSocketRails.AbstractConnection)}).call(this);